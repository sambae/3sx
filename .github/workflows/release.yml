name: Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build_macos:
    name: Build macOS
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install dependencies
        run: sh build-deps.sh

      - name: Build
        run: |
          set -o pipefail
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel 2>&1 | tee build.log
        shell: bash

      - name: Package DragNDrop DMG
        run: |
          set -euo pipefail
          cpack -G DragNDrop --config build/CPackConfig.cmake

          DMG_PATH="$(find . -maxdepth 1 -type f -name '*.dmg' | head -n 1)"
          if [ -z "${DMG_PATH}" ]; then
            echo "No .dmg package found in build/"
            exit 1
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          DMG_NAME="3sx-macos-${SHORT_SHA}.dmg"
          mv "${DMG_PATH}" "${DMG_NAME}"
          shasum -a 256 "${DMG_NAME}" > "${DMG_NAME}.sha256"
        shell: bash

      - name: Upload macOS release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-macos
          path: |
            3sx-macos-*.dmg
            3sx-macos-*.dmg.sha256

      - name: Upload macOS build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-macos
          path: build.log

  build_windows:
    name: Build Windows
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - id: msys2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          msystem: MINGW64
          install: >-
            make
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-clang
            mingw-w64-x86_64-headers-git

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build dependencies
        run: sh build-deps.sh

      - name: Build
        run: |
          set -o pipefail

          CC=clang CXX=clang++ cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DMSYS2_LOCATION=${{ steps.msys2.outputs.msys2-location }}

          cmake --build build --parallel 2>&1 | tee build.log

      - name: Install
        run: cmake --install build --prefix dist

      - name: Package ZIP
        shell: pwsh
        run: |
          $shortSha = "${env:GITHUB_SHA}".Substring(0, 7)
          $archiveName = "3sx-windows-$shortSha.zip"

          Compress-Archive -Path "dist\*" -DestinationPath $archiveName -Force

          $hash = (Get-FileHash -Algorithm SHA256 $archiveName).Hash.ToLower()
          "$hash  $archiveName" | Out-File -FilePath "$archiveName.sha256" -Encoding ascii

      - name: Upload Windows release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-windows
          path: |
            3sx-windows-*.zip
            3sx-windows-*.zip.sha256

      - name: Upload Windows build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-windows
          path: build.log

  release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs:
      - build_macos
      - build_windows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release assets
        uses: actions/download-artifact@v4
        with:
          pattern: release-assets-*
          merge-multiple: true
          path: release-assets

      - name: Create or update GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          TAG_NAME: sha-${{ github.sha }}
        run: |
          set -euo pipefail

          if gh release view "${TAG_NAME}" >/dev/null 2>&1; then
            gh release upload "${TAG_NAME}" release-assets/* --clobber
          else
            gh release create "${TAG_NAME}" release-assets/* \
              --title "Release ${TAG_NAME}" \
              --notes "Automated release for commit ${{ github.sha }}."
          fi
